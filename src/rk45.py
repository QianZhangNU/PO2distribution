# -*- coding: utf-8 -*-
"""
Created on Wed Jul  1 17:55:13 2020

@author: qianj
"""
import numpy as np

def rk45(yprime, tspan, y0, n, *arg):


  m = len(y0);
  t = np.zeros (( n + 1, 1 ), dtype=float)
  y = np.zeros (( n + 1, m ), dtype=float)
  e = np.zeros (( n + 1, m ), dtype=float)

  dt = (tspan[1]- tspan[0]) / n

  t[0][0] = tspan[0]
  y[0][:] = y0[:]
  e[0][:] = 0.0
 
  a = [[           0.0,            0.0,            0.0,           0.0, 0.0],
        [         0.25,            0.0,            0.0,           0.0, 0.0],
        [     3.0/32.0,       9.0/32.0,            0.0,           0.0, 0.0],
       [ 1932.0/2197.0, -7200.0/2197.0,  7296.0/2197.0,           0.0, 0.0],
        [  439.0/216.0,           -8.0,   3680.0/513.0, -845.0/4104.0, 0.0],
        [    -8.0/27.0,            2.0, -3544.0/2565.0, 1859.0/4104.0, -11.0/40.0 ]]
  
  b = [ 16.0/135.0, 0.0, 6656.0/12825.0, 28561.0/56430.0, -9.0/50.0, 2.0/55.0 ]
  c = [ 0.0, 0.25, 3.0/8.0, 12.0/13.0, 1.0, 0.5 ]
  d = [ 25.0/216.0, 0.0, 1408.0/2565.0, 2197.0/4104.0, -1.0/5.0, 0.0 ]

  for i in range(0, n, 1):

    k1 = dt * yprime ( t[i] + c[0] * dt, y[i][:], *arg)
    k2 = dt * yprime ( t[i] + c[1] * dt, y[i][:] + a[1][0] * k1, *arg)
    k3 = dt * yprime ( t[i] + c[2] * dt, y[i][:] + a[2][0] * k1\
      + a[2][1] * k2, *arg)
    k4 = dt * yprime ( t[i] + c[3] * dt, y[i][:] + a[3][0] * k1\
      + a[3][1] * k2 + a[3][2] * k3, *arg)
    k5 = dt * yprime ( t[i] + c[4] * dt, y[i][:] + a[4][0] * k1\
      + a[4][1] * k2+ a[4][2] * k3 + a[4][3] * k4, *arg)
    k6 = dt * yprime ( t[i] + c[5] * dt, y[i][:] + a[5][0] * k1\
      + a[5][1] * k2 + a[5][2] * k3 + a[5][3] * k4 + a[5][4] * k5,*arg)

    y4 = y[i][:] + d[0] * k1 + d[1] * k2 + d[2] * k3 \
                + d[3] * k4 + d[4] * k5 + d[5] * k6
                
    y5 = y[i][:] + b[0] * k1 + b[1] * k2 + b[2] * k3\
                + b[3] * k4 + b[4] * k5 + b[5] * k6

    t[i+1][0] = t[i][0] + dt
    y[i+1][:] = y5
    e[i+1][:] = y5 - y4

  

  return t, y, e

